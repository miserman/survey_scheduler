# survey scheduler
A Node.js app to schedule texts for experience sampling studies.

<img src='docs/icon.png' width='200px'>

## demo
The [demo study](https://miserman.github.io/survey_scheduler/?study=demo) is a disintegrated version of the interface, which can be used to test the interface.

Participants can be added to the demo study individually through the add or edit menu, or automatically generated by specifying an **n** parameter in the URL; e.g., [miserman.github.io/survey_scheduler/?study=demo&**n=50**](https://miserman.github.io/survey_scheduler/?study=demo&n=50).

Generated participants are based on the default settings in the add or edit > participant menu, which are update when changed -- change the day or time ranges, or protocol settings, and these will be applied to newly generated participants.

Clear local storage (menu > clear storage), or change the specified **n** and refresh to generate new participants.

## services
The app uses these [Amazon Web Services](https://aws.amazon.com/) (AWS):

[**Cognito**](https://aws.amazon.com/cognito/): To manage user accounts
1. From the [Cognito console](https://console.aws.amazon.com/cognito/users), make Create a user pool
    1. In Policies, select Only allow administrators to create users
    1. In App Clients, Add an app client, and check only Enable SRP
    1. Create Pool
1. Create an initial, administrative user with General settings > Users and groups > Create user
1. Set up the App client in App integration > App client settings:
    1. Under Enabled Identity Providers, check Cognito User Pool
    1. In Sign in sign out URLs, enter your URL, with /auth appended to the Callback URL (e.g., http://localhost:3000/auth for testing)
    1. In OAuth 2.0, check Authorization code grant and aws.cognito.signin.user.admin

[**DynamoDB**](https://aws.amazon.com/dynamodb/): To store study information and participant details

[**SNS**](https://aws.amazon.com/sns/): To send the SMS messages

The app needs AWS access to run these services, which can be set up through [IAM](https://console.aws.amazon.com/iam/home#/users):
1. Add user
1. Name whatever, and check Programmatic access
1. Select Attach existing policies directly, and add these policies:
    * AmazonCognitoPowerUser
    * AmazonDynamoDBFullAccess
    * AmazonSNSFullAccess
1. Add the Access key ID and Secret access key to a "credentials" file in, e.g., c:/users/name/.aws:
```
[default]
aws_access_key_id = Access key ID
aws_secret_access_key = Secret access key
```
### Qualtrics
The app is set up with [Qualtrics](https://www.qualtrics.com) in mind, though other platforms could be used. The app sends survey links with an added participant ID parameter, which the survey would need to extract in order to associate participants with responses through the link. In Qualtrics, you can get this by setting an Embeded Data variable matching the protocol's specified ID parameter:
1. In a survey, select Survey Flow
1. Add an Emdeded Data element from the Add a New Element Here menu
1. Create New Field matching your ID parameter (e.g., "id"), and leave its value blank.

Qualtrics can also checkin with the app when the survey is accessed:
1. In a survey, select Survey Flow
1. Add a Web Service element from the Add a New Element Here menu
1. Enter your URL appended with /checkin
1. Set Method to POST
1. Add a body parameter, and set its Body Parameters to application/json, Parameter to your ID parameter, and set a String to the extracted ID via Piped Text (e.g., ${e://Field/id})
1. Finally, Add Embedded Data..., and set a value for available, day, days, beep, and beeps

If the app recognizes the ID, it responds with an object like this:
```javascript
{
  available: true,
  day: 0,
  days: 12,
  beep: 1,
  beeps: 6
}
```
Here, available is based on the most recently passed beep and the associated protocol's close after setting. That is, available will be true if a beep was sent no longer ago than the associated protocol's close after setting, or the associated protocol has no close after setting.

This information can be used from within Qualtrics to regulate access or condition questions on schedule status. For example, adding this as a question's JavaScript would prevent proceeding if available is false, and otherwise display schedule information:
```javascript
Qualtrics.SurveyEngine.addOnload(function(){
  var message = $("message"), id = "${e://Field/id}", response = {
    available: "${e://Field/available}",
    beeps: "${e://Field/beeps}",
    beep: "${e://Field/beep}",
    days: "${e://Field/days}",
    day: "${e://Field/day}",
  }
  this.disableNextButton()
  if(id.value !== "" && response.available === "true"){
    message.innerText = "Participant " + id + "; survey " + response.beep + " of "
      + response.beeps + " for day " + response.day + " of " + response.days + "."
    this.enableNextButton()
  }
});
```
Here, message refers to an HTML element in the question's body, with "message" as its id, e.g.:
```html
<p id="message">Wait for a text to complete this survey.<p>
```

## environment variables
[server.js](https://github.com/miserman/survey_scheduler/blob/master/server.js) uses these environment variables:
* **PORT**: The port the server listens to; often 3000 or 8081
* **REGION**: AWS region, e.g., "us-east-1"
* **USERPOOL**: Cognito Pool ID, from [User Pool](https://console.aws.amazon.com/cognito/users) > General settings
* **CLIENT**: Cognito App client ID, from [User Pool](https://console.aws.amazon.com/cognito/users) > App integration > App client settings
* **DOMAIN**: Cognito domain, from [User Pool](https://console.aws.amazon.com/cognito/users) > App integration > Domain name
* **REDIRECT**: URL set as the callback in [User Pool](https://console.aws.amazon.com/cognito/users) > App integration > App client settings; [server.js](https://github.com/miserman/survey_scheduler/blob/master/server.js) assumes this is /auth
* **ADMIN**: Username of an initial user set up through [User Pool](https://console.aws.amazon.com/cognito/users) > General settings > Users and groups > Create user; this user has full access to all studies; additional, study specific users should be created through the interface
